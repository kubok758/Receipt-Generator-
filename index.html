<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ß–µ–∫–æ–≤</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: row;
            padding: 20px;
            gap: 20px;
            align-items: flex-start;
            margin: 0;
            box-sizing: border-box;
        }

        /* --- –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ --- */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            width: 350px;
            flex-shrink: 0;
        }

        h2, h3 { margin-top: 0; color: #333; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; color: #555; }
        
        input { 
            width: 100%; padding: 12px; box-sizing: border-box; 
            border: 1px solid #ddd; border-radius: 8px; font-size: 16px; outline: none;
        }
        input:focus { border-color: #007bff; }

        .items-control { border-top: 2px dashed #eee; padding-top: 20px; margin-top: 20px; }
        .price-qty-row { display: flex; gap: 10px; }
        
        .btn {
            background-color: #007bff; color: white; border: none; padding: 14px; 
            border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; 
            font-size: 16px; font-weight: 600;
        }
        .btn-add { background-color: #28a745; margin-bottom: 15px; }
        
        #itemsList .item-preview {
            background: #f8f9fa; padding: 10px; margin-bottom: 8px; 
            border-radius: 6px; display: flex; justify-content: space-between; align-items: center; font-size: 14px;
        }
        .delete-btn { color: #dc3545; padding: 5px 10px; cursor: pointer; font-weight: bold; font-size: 18px; }

        /* --- –ß–ï–ö --- */
        .receipt-wrapper {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            background: #e9ecef;
            padding: 20px;
            border-radius: 12px;
            overflow: auto;
        }

        #receipt {
            width: 380px;
            min-width: 380px;
            box-sizing: border-box; 
            background-color: #fff;
            font-family: 'VT323', monospace;
            font-size: 19px;
            line-height: 1.1;
            color: #000;
            padding: 15px 12px 30px 12px;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            position: relative;
        }

        .center { text-align: center; }
        .bold { font-weight: bold; }
        
        .divider { 
            white-space: nowrap; 
            overflow: hidden; 
            width: 100%;
            margin: 5px 0;
            text-align: center;
        }

        /* –¢–æ–≤–∞—Ä—ã */
        .item-row { margin-bottom: 8px; }
        .item-name { 
            text-align: left; 
            word-wrap: break-word;
        }
        .item-math { 
            text-align: right; 
            margin-top: 2px;
        }

        /* –ò–¢–û–ì */
        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 26px;
            margin: 5px 0;
        }

        /* –û–ø–ª–∞—Ç–∞ */
        .payment-row {
            display: flex;
            justify-content: space-between;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä QR: –¥–æ–±–∞–≤–∏–ª min-height —á—Ç–æ–±—ã –º–µ—Å—Ç–æ –Ω–µ –∏—Å—á–µ–∑–∞–ª–æ */
        #qrcode-container {
            display: flex; 
            justify-content: center; 
            margin-top: 20px; 
            margin-bottom: 10px;
            min-height: 150px; /* –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –º–µ—Å—Ç–æ */
            align-items: center;
        }
        
        #qr-code img {
            width: 150px;  /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä */
            height: 150px;
            display: block; 
            image-rendering: pixelated; /* –î–ª—è —á–µ—Ç–∫–æ—Å—Ç–∏ */
        }

        @media screen and (max-width: 800px) {
            body { flex-direction: column; padding: 10px; gap: 15px; }
            .controls { width: 100%; padding: 15px; }
            .receipt-wrapper { width: 100%; padding: 10px 0; display: block; overflow-x: auto; }
            #receipt { margin: 0 auto; }
            .price-qty-row input { width: 50%; }
        }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

    <div class="controls">
        <h2>üßæ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ–∫–∞</h2>
        
        <div class="input-group">
            <label>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</label>
            <input type="text" id="orgName" value='–û–û–û "–ú–æ—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è"' oninput="renderReceipt()">
        </div>
        <div class="input-group">
            <label>–ò–ù–ù</label>
            <input type="tel" id="inn" value="0000000000" oninput="renderReceipt()">
        </div>
        <div class="input-group">
            <label>–ê–¥—Ä–µ—Å</label>
            <input type="text" id="address" value="–≥. –ì–æ—Ä–æ–¥, —É–ª. –£–ª–∏—Ü–∞, –¥. 1" oninput="renderReceipt()">
        </div>

        <div class="items-control">
            <h3>–¢–æ–≤–∞—Ä—ã</h3>
            <div class="input-group">
                <input type="text" id="newItemName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
            </div>
            <div class="input-group price-qty-row">
                <input type="number" id="newItemPrice" placeholder="–¶–µ–Ω–∞" inputmode="decimal">
                <input type="number" id="newItemQty" value="1" placeholder="–ö–æ–ª-–≤–æ" inputmode="numeric">
            </div>
            <button class="btn btn-add" onclick="addItem()">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
            
            <div id="itemsList"></div>
        </div>
        
        <button class="btn" style="background-color: #333; margin-top: 20px;" onclick="downloadReceipt()">üì• –°–∫–∞—á–∞—Ç—å —á–µ–∫ (JPG)</button>
    </div>

    <div class="receipt-wrapper">
        <div id="receipt">
            <div class="center bold" id="r-org">–û–û–û "–ú–æ—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è"</div>
            <div class="center">–ò–ù–ù: <span id="r-inn">0000000000</span></div>
            <div class="center" id="r-address">–≥. –ì–æ—Ä–æ–¥, —É–ª. –£–ª–∏—Ü–∞, –¥. 1</div>
            
            <div class="divider">----------------------------------------------------</div>
            <div>–î–∞—Ç–∞: <span id="r-date"></span> –í—Ä–µ–º—è: <span id="r-time"></span></div>
            <div class="bold">–¢–û–í–ê–†–ù–´–ô –ß–ï–ö</div>
            
            <div class="divider">*************************************************************</div>
            
            <div id="r-items"></div>

            <div class="divider">*************************************************************</div>
            
            <div class="total-row">
                <span>–ò–¢–û–ì:</span>
                <span id="r-total">0.00‚ÇΩ</span>
            </div>
            
            <div class="payment-row">
                <span>–û–ø–ª–∞—Ç–∞:</span>
                <span>–ë–ï–ó–ù–ê–õ–ò–ß–ù–´–ú–ò</span>
            </div>

            <div class="divider">----------------------------------------------------</div>
            <div class="center">–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É!</div>
            
            <div id="qrcode-container">
                <div id="qr-code"></div>
            </div>
        </div>
    </div>

    <script>
        let items = [];
        items.push({name: "–¢–æ–≤–∞—Ä 1", price: 100, qty: 1});
        items.push({name: "–¢–æ–≤–∞—Ä 2", price: 249.99, qty: 5});

        function updateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('ru-RU');
            const timeStr = now.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
            document.getElementById('r-date').innerText = dateStr;
            document.getElementById('r-time').innerText = timeStr;
        }

        function addItem() {
            const nameInput = document.getElementById('newItemName');
            const priceInput = document.getElementById('newItemPrice');
            const qtyInput = document.getElementById('newItemQty');

            const name = nameInput.value.trim() || "–¢–æ–≤–∞—Ä";
            const price = parseFloat(priceInput.value) || 0;
            const qty = parseFloat(qtyInput.value) || 1;

            if (price <= 0) return;

            items.push({name, price, qty});
            
            nameInput.value = '';
            priceInput.value = '';
            qtyInput.value = '1';
            nameInput.focus();
            
            renderReceipt();
        }

        function deleteItem(index) {
            items.splice(index, 1);
            renderReceipt();
        }

        function renderReceipt() {
            document.getElementById('r-org').innerText = document.getElementById('orgName').value;
            document.getElementById('r-inn').innerText = document.getElementById('inn').value;
            document.getElementById('r-address').innerText = document.getElementById('address').value;

            const itemsContainer = document.getElementById('r-items');
            const itemsListControl = document.getElementById('itemsList');
            itemsContainer.innerHTML = '';
            itemsListControl.innerHTML = '';
            
            let totalSum = 0;

            items.forEach((item, index) => {
                const itemTotal = item.price * item.qty;
                totalSum += itemTotal;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'item-row';
                itemDiv.innerHTML = `
                    <div class="item-name">${index + 1}. ${item.name}</div>
                    <div class="item-math">${item.qty} x ${item.price.toFixed(2)} = ${itemTotal.toFixed(2)}</div>
                `;
                itemsContainer.appendChild(itemDiv);

                const controlDiv = document.createElement('div');
                controlDiv.className = 'item-preview';
                controlDiv.innerHTML = `
                    <div style="flex-grow:1"><b>${item.name}</b><br><span style="color:#666">${item.qty} —à—Ç. x ${item.price}‚ÇΩ</span></div>
                    <div class="delete-btn" onclick="deleteItem(${index})">‚úï</div>
                `;
                itemsListControl.appendChild(controlDiv);
            });

            document.getElementById('r-total').innerText = totalSum.toFixed(2) + "‚ÇΩ";

            // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø QR (–ù–æ–≤–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ qrcode-generator) ---
            const qrText = `–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ ${totalSum.toFixed(2)}‚ÇΩ. –ñ–¥—ë–º –≤–∞—Å —Å–Ω–æ–≤–∞!`;
            
            const qrContainer = document.getElementById("qr-code");
            qrContainer.innerHTML = ""; // –û—á–∏—Å—Ç–∫–∞

            try {
                // –¢–∏–ø 0 = –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞, 'M' = —É—Ä–æ–≤–µ–Ω—å –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏
                var qr = qrcode(0, 'M');
                
                // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ (UTF-8)
                qr.addData(unescape(encodeURIComponent(qrText)));
                qr.make();
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML —Ç–µ–≥ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Å —Ä–∞–∑–º–µ—Ä–æ–º –º–æ–¥—É–ª—è 4 (–º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è CSS)
                qrContainer.innerHTML = qr.createImgTag(4);
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ QR:", e);
                qrContainer.innerText = "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞";
            }
        }

        function downloadReceipt() {
            const receiptElement = document.getElementById('receipt');
            receiptElement.scrollIntoView({behavior: "smooth"});

            setTimeout(() => {
                html2canvas(receiptElement, {
                    scale: 3,
                    backgroundColor: "#ffffff",
                    logging: false
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'check_' + Date.now() + '.jpg';
                    link.href = canvas.toDataURL('image/jpeg', 0.95);
                    link.click();
                });
            }, 500);
        }

        updateTime();
        renderReceipt();
    </script>
</body>
</html>

